# DeepSeek R1 參數自動測試系統使用指南

## 📋 系統概述

`test_r1_params.py` 是一個自動化測試系統，用於系統化驗證不同 DeepSeek R1 參數組合對大綱生成品質的影響。

## 🚀 快速開始

### 基本使用

```bash
# 快速測試模式（10 組關鍵參數，推薦）
python test_r1_params.py --quick

# 完整測試模式（240 組所有組合，耗時較長）
python test_r1_params.py --full

# 默認模式（等同於 --quick）
python test_r1_params.py
```

### 測試時間估算

| 模式 | 組合數 | 預計時間 | 適用場景 |
|------|--------|---------|---------|
| **快速測試** | 10 組 | 5-10 分鐘 | 日常測試、參數微調 |
| **完整測試** | 240 組 | 2-4 小時 | 系統化研究、論文數據 |

## 🔬 測試配置

### 參數測試矩陣

完整測試模式會測試以下所有組合：

```python
PARAM_MATRIX = {
    'temperature': [0.3, 0.4, 0.5, 0.6, 0.7],        # 5 個值
    'top_p': [0.8, 0.85, 0.9, 0.95],                # 4 個值
    'repetition_penalty': [1.0, 1.05, 1.1, 1.15],   # 4 個值
    'max_tokens': [6000, 8000, 10000]               # 3 個值
}
# 總組合數：5 × 4 × 4 × 3 = 240 組
```

### 快速測試關鍵組合

快速測試模式包含 10 組關鍵參數：

1. **緊急修復參數**（當前使用）：`temp=0.4, top_p=0.85, rep=1.1, tok=8000`
2. **R1 官方參數**：`temp=0.5, top_p=0.95, rep=1.0, tok=8192`
3. **保守配置**：`temp=0.3, top_p=0.85, rep=1.1, tok=8000`
4. **激進配置**：`temp=0.6, top_p=0.85, rep=1.1, tok=8000`
5. 其他關鍵變體（調整單一參數）

## 📊 品質評估系統

### 評分標準（總分 100 分）

#### A. 格式品質（40 分）

| 指標 | 分值 | 檢查內容 |
|------|------|---------|
| 無 `<think>` 標籤洩漏 | 10 | 思考過程是否被過濾 |
| 無星號佔位符 | 10 | 是否用 `*****` 代替內容 |
| 無省略號佔位符 | 10 | 是否用 `...` 代替內容 |
| 無中英文混雜 | 10 | 是否純繁體中文 |

#### B. 內容品質（40 分）

| 指標 | 分值 | 檢查內容 |
|------|------|---------|
| 章節標題有差異 | 10 | 標題是否重複 |
| 情節描述具體 | 10 | 是否包含具體動作 |
| 角色名稱完整 | 10 | 是否有具體角色名 |
| 章節間無高度重複 | 10 | 情節是否重複 |

#### C. 長度品質（20 分）

| 指標 | 分值 | 檢查內容 |
|------|------|---------|
| 大綱長度適中 | 10 | 2000-5000 字為最佳 |
| 每章描述充分 | 10 | 每章至少 50 字 |

### 評分邏輯

- **滿分（1.0）**：完全符合標準
- **部分分數（0.3-0.7）**：部分符合
- **零分（0.0）**：完全不符合

每項指標分數 × 10 = 該項分值

## 📁 輸出結果

### 目錄結構

```
test_results/
├── outlines/                          # 所有測試大綱
│   ├── outline_001_score95.txt       # 第1組測試，總分95
│   ├── outline_002_score87.txt       # 第2組測試，總分87
│   └── ...
└── r1_params_test_report_YYYYMMDD_HHMMSS.md  # 測試報告（帶時間戳）
└── r1_params_test_report_latest.md   # 最新測試報告
```

### 測試報告內容

報告包含以下章節：

1. **測試配置**：模式、組合數、耗時
2. **最佳參數組合**：Top 3 🥇🥈🥉
3. **詳細測試結果**：完整排序表格
4. **參數影響分析**：
   - Temperature 影響
   - Top_P 影響
   - Repetition Penalty 影響
   - Max Tokens 影響
5. **建議配置**：基於測試結果的最佳配置

## 🔍 實時監控

測試過程中會顯示：

```
============================================================
測試 5/10
參數: temp=0.4, top_p=0.85, rep=1.1, max_tok=8000
============================================================
✅ 測試完成 - 總分: 95/100

💡 當前最佳: 總分 95/100
   參數: temp=0.4, top_p=0.85, rep=1.1, max_tok=8000

⏱️  進度: 5/10 (50.0%)
   已用時間: 2.5 分鐘
   預計剩餘: 2.5 分鐘
```

## 📝 使用案例

### 案例 1: 驗證當前配置

```bash
# 運行快速測試，確認當前緊急修復參數是否最佳
python test_r1_params.py --quick

# 查看報告
cat test_results/r1_params_test_report_latest.md
```

### 案例 2: 系統化研究

```bash
# 運行完整測試，獲取全面數據
python test_r1_params.py --full

# 分析報告中的參數影響分析
# 查找最佳 temperature、top_p 組合
```

### 案例 3: 微調優化

```bash
# 1. 修改 QUICK_PARAM_COMBINATIONS，添加新的測試組合
# 2. 運行快速測試
python test_r1_params.py --quick

# 3. 根據結果調整配置
```

## ⚙️ 自定義配置

### 添加自定義參數組合

編輯 `test_r1_params.py`：

```python
# 在 QUICK_PARAM_COMBINATIONS 列表中添加
QUICK_PARAM_COMBINATIONS = [
    # ... 現有組合 ...

    # 你的自定義組合
    {'temperature': 0.45, 'top_p': 0.88, 'repetition_penalty': 1.12, 'max_tokens': 7000},
]
```

### 調整評分權重

如果需要調整某些指標的重要性，修改評分邏輯：

```python
# 在 evaluate_quality() 方法中
score['format_score'] = (think_score + star_score + dot_score + lang_score) * 10  # 40分
score['content_score'] = (unique_score + concrete_score + names_score + repeat_score) * 10  # 40分
score['length_score'] = (length_score + chapter_score) * 10  # 20分
```

## 🐛 故障排除

### 問題 1: API Key 未設置

```
❌ 錯誤: 未檢測到 SILICONFLOW_API_KEY
```

**解決**：確保 `.env` 文件包含 API Key：
```
SILICONFLOW_API_KEY=your_api_key_here
```

### 問題 2: 測試中斷

如果測試中斷，已完成的結果會保存在 `test_results/outlines/`。

重新運行測試會從頭開始（不會續接）。

### 問題 3: 磁盤空間不足

每個測試大綱約 2-5KB，完整測試需要約 1-2MB 空間。

清理舊測試數據：
```bash
rm -rf test_results/outlines/*
```

## 📈 結果解讀

### 分數含義

| 總分範圍 | 評級 | 說明 |
|---------|------|------|
| 90-100 | 優秀 ⭐⭐⭐ | 可直接用於生產 |
| 80-89 | 良好 ⭐⭐ | 小幅調整即可 |
| 70-79 | 合格 ⭐ | 需要優化 |
| <70 | 不合格 | 不建議使用 |

### 參數影響解讀

#### Temperature
- **0.3-0.4**：穩定但可能缺乏創意
- **0.5-0.6**：平衡創意和穩定性
- **0.7+**：創意但可能不穩定

#### Top_P
- **0.8-0.85**：聚焦，適合格式化輸出
- **0.9-0.95**：開放，適合創意生成

#### Repetition Penalty
- **1.0**：不懲罰重複
- **1.1-1.15**：輕度懲罰，保持流暢

#### Max Tokens
- **6000**：可能截斷
- **8000**：平衡
- **10000+**：充足但浪費

## 🎯 最佳實踐

1. **定期測試**：每次修改提示詞後運行快速測試
2. **記錄結果**：保存報告，建立參數知識庫
3. **交叉驗證**：不同主題、類型的小說測試
4. **A/B 對比**：對比新舊參數的實際效果

## 📚 相關文檔

- `R1_OFFICIAL_PARAMS_TEST_REPORT.md` - R1 官方參數測試報告
- `EMERGENCY_FIX_R1.md` - 緊急修復報告
- `R1_PARAMS_FINAL_SUMMARY.md` - 參數配置最終總結

## 🔄 更新日誌

### v1.0.0 (2026-01-10)
- ✅ 初始版本
- ✅ 支持快速/完整測試模式
- ✅ 10 項品質評估指標
- ✅ 自動生成 Markdown 報告
- ✅ 實時進度監控
- ✅ 參數影響分析
